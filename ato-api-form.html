<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAACMuAAAjLgAAAAAAAAAAAAAAAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AwMD/wQEBP8EBAT/AwMD/wMDA/8DAwP/AgIC/wAAAP8DAwP/BAQE/wQEBP8DAwP/AAAA/wAAAP8AAAD/AgIC/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8CAgL/AAAA/wAAAP8AAAD/AAAA/wICAv8AAAD/AQEB/wAAAP9fX1//vLy8/6Wlpf9UVFT/dnZ2/2hoaP9bW1v/AAAA/0ZGRv+ysrL/t7e3/1BQUP8AAAD/AgIC/wAAAP+Ojo7/9PT0/35+fv+ampr//////9LS0v+wsLD/iYmJ/01NTf//////j4+P/4aGhv/6+vr/dXV1/wAAAP8oKCj/6+vr/ykpKf8AAAD/AAAA/3BwcP/c3Nz/pKSk/5eXl//Nzc3/W1tb/wAAAP8AAAD/QUFB/+fn5/8TExP/UFBQ/9XV1f8AAAD/CgoK/wAAAP82Njb/1dXV/6ampv+0tLT/1NTU/yAgIP8BAQH/BgYG/wwMDP/g4OD/NDQ0/x4eHv/s7Oz/PT09/wAAAP8AAAD/h4eH/9zc3P+np6f/kZGR/7m5uf9tbW3/AAAA/wAAAP9WVlb/5OTk/wsLC/8AAAD/dXV1//v7+/+ZmZn/sbGx//j4+P/r6+v/4eHh/8zMzP/Gxsb//////7Gxsf+rq6v//v7+/1xcXP8AAAD/AgIC/wAAAP9ISEj/yMjI/6+vr/9jY2P/ioqK/9jY2P/a2tr/iYmJ/4qKiv+bm5v/k5OT/zMzM/8AAAD/AgIC/wICAv8AAAD/LS0t/9TU1P/Nzc3/6Ojo/yYmJv+FhYX/jY2N/wAAAP8EBAT/AAAA/wAAAP8AAAD/AgIC/wAAAP8AAAD/AAAA/wUFBf8RERH/EBAQ/w8PD/8HBwf/CAgI/wkJCf8EBAT/BAQE/wQEBP8EBAT/AgIC/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wEBAf8BAQH/AQEB/wAAAP8BAQH/AQEB/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="Āto API v0.9.3-beta" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6"
      crossorigin="anonymous"
    />
	<script src="https://cdn.jsdelivr.net/gh/emn178/js-sha3/build/sha3.min.js"></script>
    <title>Āto API v0.9.3-beta</title>

  </head>
  <body onload="bodyLoad()">
	<style>
		.displayFlex {
			display: flex;
			justify-content: center;
		}
		.displayBlock {
			margin-left: 10px;
			margin-right: 10px;
			margin-top: 10px;
			border: 2px solid black;
			padding-left: 10px;
			padding-bottom: 5px;
			padding-top: 5px;
		}
		label {
			margin-right: 5px;
		}
		input, select {
			margin-bottom: 5px;
		}
		input[type=checkbox] {
			margin-right: 5px;
		}
	</style>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div name="root">
		<div class="displayFlex"><h1>Āto IP License Generator</h1></div>
		<div class="displayFlex"><h2>Āto API v0.9.3-beta Client</h2></div>
		<form>
			<div class="displayBlock" style="border-color: red;">
				<h5>Artwork</h5>
				<div><label style="min-width: 120px;">Name:</label><input name="ArtworkName" value="NFT #1" type="text" minlength="1" maxlength="32" size="40"/></div>
				<div><label style="min-width: 116px;">NFT Standard:</label>
					<select id="NftStandard" name="NftStandard">
						<option>ERC-721</option>
						<option>ERC-1155</option>
					</select>
				</div>
				<div><label style="min-width: 116px;">License type:</label>
					<select id="NftLicence" name="NftLicence">
						<option>Art</option>
						<option>Gaming</option>
						<option>Redeemable</option>
					</select>
				</div>
				<div><label>Artwork Description:</label></div>
				<div><textarea style="resize: none;" name="ArtworkDesc" rows="10" cols="80" maxlength="1000" minlength="10">This is a demo.</textarea></div>
			</div>
			<div class="displayBlock">
				<h5>Image</h5>
				<div><label style="min-width: 80px;">File Name:</label><input name="FileName" value="artwork.png" type="text" minlength="1" maxlength="32" size="40" title="File name of Artwork" required/></div>
				<div><label style="min-width: 80px;">File Type:</label><input name="FileType" value="png" type="text" minlength="1" maxlength="8" size="10" title="File type of Artwork, ex: png, gif, jpeg, ..." required/></div>
				<div><label style="min-width: 80px;">File Size:</label><input name="FileSize" value="24000" type="number" min="1" max="40000000" size="10" title="Size of Artwork in Bytes (max: 40,000,000)" required/></div>
			</div>
			<div class="displayBlock" style="border-color: green;">
				<h5>Artist</h5>
				<div><label style="min-width: 80px;">Name:</label><input name="CreatorName" value="Francis"/></div>
				<div><label style="min-width: 80px;">Address:</label><input name="CreatorAddress" value="0x0000000000000000000000000000000000000000" type="text" minlength="42" maxlength="42"  size="50"/></div>
				<div><label style="min-width: 76px;">Network:</label>
					<select id="ListNetwork" name="ListNetwork">
						<option>Polygon</option>
						<option>Ethereum</option>
						<option>Rinkeby</option>
					</select>
				</div>
			</div>
			<div class="displayBlock" style="border-color: blue;">
				<h5>Rights</h5>
				<div style="display:table;margin: auto 0;">
					<div style="display:table-cell;padding-right: 10px"><label>Level:</label><input id="RightLevelId" name="RightLevel" type="number" value="3" min="1" max="3" size="5" onchange="changeLevel()" onkeydown="return false;"/></div>
					<div style="display:table-cell;padding-right: 10px;display: none" id="RightAdaptId"><input id="RightAdapt" name="RightAdapt" type="checkbox"/><label for="RightAdapt">Right to adapt</label></div>
					<div style="display:table-cell;padding-right: 10px;display: none" id="RightLogoId"><input id="RightLogo" name="RightLogo" type="checkbox"/><label for="RightLogo">Right to add a logo</label></div>
					<div style="display:table-cell;display: none" id="RightMerchId"><input id="RightMerch" name="RightMerch" type="checkbox"/><label for="RightMerch">Merchandising rights</label></div>
				</div>
				<div><label>Rights Duration:</label>
					<select id="yearsSelector" name="RightDuration" value="70">
					</select>
				</div>
				<div style="display:table;margin: auto 0;">
					<div style="display:table-cell;padding-right: 10px"><label>Supply Number:</label><input id="SupplyNumberId" name="SupplyNumber" type="number" value="1" min="1" max="150" size="5" onchange="changeSupplyNumber()"/></div>
					<div style="display:table-cell;" id="RightExclusiveId"><input id="RightExclusive" name="RightExclusive" type="checkbox" checked/><label for="RightExclusive">Exclusive license</label></div>
				</div>
				<div><input id="NonReissuance" name="NonReissuance" type="checkbox" checked/><label for="NonReissuance">NFT non-reissuance guarantee</label></div>
				<div><label>Resale Right Percentage:</label>
					<select id="rightResaleSelector" name="ResaleRight" style="min-width: 100px;">
					</select>
				</div>
			</div>
			<div class="displayBlock" style="border-color: red;">
				<h5>Pro version</h5>
				<div><label>User address: </label><input id="userKey" name="userKey" type="text" value="" type="text" minlength="42" maxlength="42" size="50" /></div>
				<div><label>Key File: </label><input type="file" onchange="loadKey(this)"/></div>
			</div>
			<div class="displayBlock" style="border-color: #f8f800;">
				<h5>Divers</h5>
				<div><label style="min-width: 76px;">Api version:</label>
					<select id="VersionApi" name="VersionApi">
						<option>v1.0</option>
					</select>
				</div>
				<div><input id="CmdCheckId" name="CmdCheck" type="checkbox"/><label for="CmdCheckId">Data validation only (no Pdf)</label></div>
			</div>
			<div style="margin-top: 20px; margin-left: 100px;">
				<button type="submit" style="padding-left: 20px; padding-right: 20px;margin-bottom: 20px;">Download License</button>
			</div>
		</form>
		<div><input id="signature" name="signature" type="text" value="" hidden/></div>
		<a id="downloadLink" style="display: none" href=""></a>
		<div id="loader" style="z-index: 5; top: 100px; left: 100px; display: none; position: absolute;">
			<img src="loader.gif" />
		</div>
	</div>
    <script type="text/javascript">
		const form = document.querySelector('form');
		form.addEventListener('submit', handleSubmit);
		var httpRequest;

		function bodyLoad() {
			changeLevel();
			let yearsSelector = document.getElementById("yearsSelector");
			for (i = 1; i < 71; i++) {
				var opt = document.createElement('option');
				opt.value = i;
				opt.innerHTML = i + (i === 1 ? " year":" years");
				if (i === 70) opt.selected = true;
				yearsSelector.appendChild(opt);
			}
			let rightResaleSelector = document.getElementById("rightResaleSelector");
			for (i = 0; i < 10; i++) {
				var opt = document.createElement('option');
				opt.value = "" + i;
				if (i === 8) opt.selected = true;
				opt.innerHTML = i + ".0 %";
				rightResaleSelector.appendChild(opt);
				var opt = document.createElement('option');
				opt.value = "" + i + ".5";
				opt.innerHTML = i + ".5 %";
				rightResaleSelector.appendChild(opt);
			}
			var opt = document.createElement('option');
			opt.value = i;
			opt.innerHTML = i + " %";
			rightResaleSelector.appendChild(opt);
		}

		function loadKey(e) {
			var file = e.files[0];
			var reader = new FileReader();
			reader.readAsText(file,'UTF-8');
			reader.onload = readerEvent => {
				var content = readerEvent.target.result; // this is the content!
				document.getElementById("signature").value=content;
			}
		}

		function changeSupplyNumber() {
			let supplyNumberId = document.getElementById("SupplyNumberId");
			let RightExclusiveId = document.getElementById("RightExclusiveId");
			if (supplyNumberId.value === '1') {
				RightExclusiveId.style.display="block";
			}
			else {
				RightExclusiveId.style.display="none";
			}
		}

		function changeLevel() {
			let rightLevelId = document.getElementById("RightLevelId");
			if (rightLevelId.value === '3') {
				document.getElementById("RightAdaptId").style.display="block";
				document.getElementById("RightLogoId").style.display="block";
				document.getElementById("RightMerchId").style.display="block";
			}
			else {
				document.getElementById("RightAdaptId").style.display="none";
				document.getElementById("RightLogoId").style.display="none";
				document.getElementById("RightMerchId").style.display="none";
			}
		}

		function str2ab(str) {
			var buf = new ArrayBuffer(str.length);
			var bufView = new Uint8Array(buf);
			for (var i=0, strLen=str.length; i<strLen; i++) {
				bufView[i] = str.charCodeAt(i);
			}
			return buf;
		}

		function ab2str(buf) {
			return String.fromCharCode.apply(null, new Uint8Array(buf));
		}

		function compacte(jsonStringParam) {
			var hash = keccak_256(jsonStringParam).toString();
			//console.log('keccak: ' + hash);
		}

		async function strEncode(stringToEncode) {
			var publicKey;
			//console.log('publicKey.json: ' + JSONpublicKey);
			await crypto.subtle.importKey(
				"jwk",
				JSON.parse(document.getElementById("signature").value),
				{
					name: "RSA-OAEP",
        			hash: {name: "SHA-256"}
    			},
    			false, ["encrypt"]
			)
			.then(function(publickey){
				publicKey = publickey;
			})
			.catch(function(err){
				console.error(err);
			});

			var encryptedUri;
			await crypto.subtle.encrypt({
				name: 'RSA-OAEP'
			}, publicKey, str2ab(stringToEncode))
			.then(result => {
				encryptedUri = result;
			})
			.catch(function(err){
				console.error(err);
			});
			return ab2str(encryptedUri);
		}

		async function handleSubmit(event) {
			var demo = false;
			event.preventDefault();
			if (document.getElementById("userKey").value === "") {
				demo = true;
			} else {
				if (document.getElementById("signature").value === "") {
					alert('No key file');
					return false;
				}			
			}
			document.getElementById("loader").style.visibility="visible";
			document.getElementById("loader").style.display="block";
			var xtop = (window.outerHeight / 2) - (loader.offsetHeight / 2);
			var xleft = (window.outerWidth / 2) - (loader.offsetWidth / 2);
			loader.style.top = xtop + "px";;
			loader.style.left = xleft + "px";
			const data = new FormData(event.target);
			const valueAll = Object.fromEntries(data.entries());
			var jsonString = JSON.stringify(valueAll);
			var encodedString = "";

			if (!demo) {
				var hash = keccak_256(jsonString).toString();
				//console.log('keccak_256: ' + hash);
				encodedString = await strEncode(hash);
				//console.log('The encrypted string: '+ btoa(encodedString));
				encodedString = btoa(encodedString);
			}
			makeRequest(jsonString, encodedString, document.getElementById("ListNetwork").value, document.getElementById("VersionApi").value);
			return false; //don't submit !!!
		}

		function makeRequest(JSONValues, codedString, network, apiVersion) {
			httpRequest = new XMLHttpRequest();
			if (!httpRequest) {
				alert('Abandon :( Impossible de créer une instance de XMLHTTP');
				return false;
			}
			httpRequest.onreadystatechange = alertContents;
			//xmlhttp.onerror = function() { alert("Not Connected"); }
			let httpSsl = "http://";
			let hostName = window.location.hostname;
			if(hostName.match("https://")) {
				httpSsl = "https://";
			}
			//httpRequest.open('POST', httpSsl + 'localhost:8080');
			httpRequest.open('POST', httpSsl + '195.15.234.141:8080');
			//httpRequest.setRequestHeader("Access-Control-Allow-Origin", "*");

			let data = new FormData();
			data.append('json', JSONValues);
			data.append('access', JSON.stringify({user_id:document.getElementById("userKey").value, pass:codedString, userNetwork:network, api:apiVersion}));
			httpRequest.setRequestHeader("Content-Type", 'multipart/form-data; boundary=' + data._boundary);
			httpRequest.responseType = 'arraybuffer';
			httpRequest.send(data);
		}

		function alertContents() {
			if (httpRequest.readyState === XMLHttpRequest.DONE) {
				document.getElementById("loader").style.visibility="hidden";
				document.getElementById("loader").style.display="none";
				var checkOnly = document.getElementById("CmdCheckId").checked;
				if (httpRequest.status === 200 && checkOnly) {
					var decoder = new TextDecoder("utf-8");
					alert(decoder.decode(httpRequest.response));
					return;
				}
				if (httpRequest.status === 200) {
					var fileName = httpRequest.getResponseHeader('Content-Disposition').split("filename=")[1].replaceAll('"', '');
					var blob = new Blob([httpRequest.response], {type: 'application/pdf'});
					let url = window.URL.createObjectURL(blob);
					let a = document.getElementById("downloadLink");
					a.href = url;
					if (fileName === undefined || fileName === "" ) {
						fileName = "IP_License.pdf";
					}
					a.download = fileName;
					a.click();
					window.URL.revokeObjectURL(url);
				} else {
					if (httpRequest.status === 0) {
						alert('[ERROR] No Network');
					} else {
						if (httpRequest.status === 400) {
							var decoder = new TextDecoder("utf-8");
							alert(decoder.decode(httpRequest.response));
						} else {
							alert('[ERROR] Request probleme unknown error');
						}
					}
				}
			}
		}
		/*
		function b64EncodeUnicode(str) {
    		return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
        		return String.fromCharCode(parseInt(p1, 16));
    		}))
		}

		function toHex(str) {
			var hex = '';
			var i = 0;
			while(str.length > i) {
				hex += ''+str.charCodeAt(i).toString(16).padStart(2, "0");
				i++;
			}
			return hex;
		}

		function bytesToHex(bytes) {
			return Array.from(
				bytes,
				byte => byte.toString(16).padStart(2, "0")
			).join("");
		}
		*/
	</script>
</body>
</html>